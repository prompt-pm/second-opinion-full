<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Second Opinion</title>
    <script src="https://cdn.jsdelivr.net/npm/marked@15.0.6/marked.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dompurify@3.0.6/dist/purify.min.js"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.14.8/dist/cdn.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #1a1a2e 100%);
            min-height: 100vh;
        }
        .glass {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        .glass-input {
            background: rgba(255, 255, 255, 0.08);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.15);
        }
        .glass-chip {
            background: rgba(255, 255, 255, 0.03);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            transition: background 0.12s ease-out, border-color 0.12s ease-out;
        }
        .glass-chip:hover {
            background: rgba(255, 255, 255, 0.06);
            border-color: rgba(255, 255, 255, 0.15);
        }

        .glass-card {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(15px);
            -webkit-backdrop-filter: blur(15px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        textarea::placeholder, input::placeholder {
            color: rgba(255, 255, 255, 0.4);
        }
        .drag-over {
            background: rgba(59, 130, 246, 0.2) !important;
            border-color: rgba(59, 130, 246, 0.5) !important;
        }
        .thought-bubble {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 1rem;
            padding: 0.75rem 1rem;
            display: inline-block;
            position: relative;
        }
        .spiral-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.5rem;
            margin: 2rem 0;
        }
        .spiral-row {
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        .spiral-connector {
            width: 2px;
            height: 1rem;
            background: rgba(255, 255, 255, 0.2);
        }

        /* Animations */
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes fadeOut {
            from { opacity: 1; }
            to { opacity: 0; }
        }

        /* Apple-style "breathing" - ultra slow, barely perceptible */
        @keyframes float {
            0%, 100% {
                transform: translateY(0);
            }
            50% {
                transform: translateY(-2px);
            }
        }


        /* Subtle fade with scale */
        @keyframes appleFadeIn {
            0% {
                opacity: 0;
                transform: scale(0.98) translateY(6px);
            }
            100% {
                opacity: 1;
                transform: scale(1) translateY(0);
            }
        }

        @keyframes growDown {
            from {
                opacity: 0;
            }
            to {
                opacity: 1;
            }
        }

        @keyframes pulse {
            0%, 100% {
                box-shadow: 0 0 0 0 rgba(59, 130, 246, 0.4);
            }
            50% {
                box-shadow: 0 0 20px 4px rgba(59, 130, 246, 0.3);
            }
        }

        .animate-fade-in-up {
            animation: fadeInUp 0.53s ease-out forwards;
            opacity: 0;
        }

        .animate-fade-out {
            animation: fadeOut 0.4s ease-out forwards;
        }

        .animate-grow-down {
            animation: growDown 0.27s ease-out forwards;
            opacity: 0;
        }

        /* Thought bubble with combined fade-in and float - Apple-style slow breathing */
        .bubble-1 {
            opacity: 0;
            animation: appleFadeIn 0.6s cubic-bezier(0.22, 1, 0.36, 1) 0.2s forwards, float 5s ease-in-out 0.8s infinite;
        }
        .bubble-2 {
            opacity: 0;
            animation: appleFadeIn 0.6s cubic-bezier(0.22, 1, 0.36, 1) 0.35s forwards, float 5s ease-in-out 1.1s infinite;
        }
        .bubble-3 {
            opacity: 0;
            animation: appleFadeIn 0.6s cubic-bezier(0.22, 1, 0.36, 1) 0.5s forwards, float 5s ease-in-out 1.4s infinite;
        }
        .bubble-4 {
            opacity: 0;
            animation: appleFadeIn 0.6s cubic-bezier(0.22, 1, 0.36, 1) 0.65s forwards, float 5s ease-in-out 1.7s infinite;
        }

        /* Connector delays */
        .connector-1 { animation-delay: 0.33s; }
        .connector-2 { animation-delay: 0.6s; }
        .connector-3 { animation-delay: 0.87s; }
        .connector-4 { animation-delay: 1.13s; }

        /* Copy delays */
        .copy-1 { animation-delay: 1.4s; }
        .copy-2 { animation-delay: 1.6s; }
        .copy-3 { animation-delay: 1.8s; }

        /* CTA delay */
        .cta-delay { animation-delay: 1.93s; }
        .props-delay { animation-delay: 2.13s; }

        /* Thought bubble hover effects - subtle and snappy */
        .thought-bubble {
            transition: transform 0.15s ease-out, background 0.15s ease-out, border-color 0.15s ease-out, box-shadow 0.2s ease-out;
        }

        .thought-bubble:hover {
            transform: scale(1.015) translateY(-1px);
            background: rgba(255, 255, 255, 0.06);
            border-color: rgba(255, 255, 255, 0.12);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.15);
        }

        /* CTA button pulse - subtle glow */
        .btn-pulse {
            animation: pulse 2s ease-in-out infinite;
            transition: transform 0.15s ease-out, box-shadow 0.15s ease-out;
        }

        .btn-pulse:hover {
            animation-play-state: paused;
            transform: scale(1.03);
            box-shadow: 0 0 24px 6px rgba(59, 130, 246, 0.35);
        }


        /* Input focus glow */
        .glass-input:focus {
            border-color: rgba(59, 130, 246, 0.4);
            box-shadow: 0 0 16px rgba(59, 130, 246, 0.1);
            transition: border-color 0.15s ease-out, box-shadow 0.2s ease-out;
        }


        /* Typewriter cursor */
        @keyframes blink {
            0%, 50% { opacity: 1; }
            51%, 100% { opacity: 0; }
        }
        .typing-cursor::after {
            content: '‚ñã';
            animation: blink 0.8s ease-in-out infinite;
            margin-left: 1px;
            color: rgba(255, 255, 255, 0.6);
        }

        /* Markdown rendering styles */
        .markdown-content strong {
            font-weight: 600;
            color: white;
        }
        .markdown-content em {
            font-style: italic;
        }
        .markdown-content p {
            margin-bottom: 0.75rem;
        }
        .markdown-content p:last-child {
            margin-bottom: 0;
        }
        .markdown-content ul, .markdown-content ol {
            margin-left: 1.25rem;
            margin-bottom: 0.75rem;
        }
        .markdown-content ul {
            list-style-type: disc;
        }
        .markdown-content ol {
            list-style-type: decimal;
        }
        .markdown-content li {
            margin-bottom: 0.25rem;
        }
        .markdown-content code {
            background: rgba(255, 255, 255, 0.1);
            padding: 0.125rem 0.375rem;
            border-radius: 0.25rem;
            font-family: monospace;
            font-size: 0.875em;
        }
        .markdown-content pre {
            background: rgba(0, 0, 0, 0.3);
            padding: 0.75rem;
            border-radius: 0.5rem;
            overflow-x: auto;
            margin-bottom: 0.75rem;
        }
        .markdown-content pre code {
            background: transparent;
            padding: 0;
        }
        .markdown-content a {
            color: #60a5fa;
            text-decoration: underline;
        }
        .markdown-content a:hover {
            color: #93c5fd;
        }
        .markdown-content blockquote {
            border-left: 3px solid rgba(255, 255, 255, 0.3);
            padding-left: 1rem;
            margin-left: 0;
            margin-bottom: 0.75rem;
            color: rgba(255, 255, 255, 0.7);
        }
        .markdown-content h1, .markdown-content h2, .markdown-content h3 {
            font-weight: 600;
            color: white;
            margin-bottom: 0.5rem;
        }
        .markdown-content h1 { font-size: 1.25rem; }
        .markdown-content h2 { font-size: 1.125rem; }
        .markdown-content h3 { font-size: 1rem; }

        /* Accessibility: respect user preference for reduced motion */
        @media (prefers-reduced-motion: reduce) {
            *, *::before, *::after {
                animation-duration: 0.01ms !important;
                animation-iteration-count: 1 !important;
                transition-duration: 0.01ms !important;
            }
        }

    </style>
</head>
<body class="text-white">

<div class="min-h-screen flex items-center justify-center p-4" x-data="app">

    <!-- Single Morphing Container -->
    <div class="w-full transition-all duration-500 ease-out"
         :class="inChat ? 'max-w-2xl' : 'max-w-3xl'"
         x-ref="mainContainer">
        <div class="glass rounded-3xl p-8 md:p-10 relative">

            <!-- Header Row - morphs between states -->
            <div class="flex items-center justify-between mb-6">
                <div class="flex-1 transition-all duration-500 ease-out"
                     :class="inChat ? '' : 'text-center'">
                    <h1 class="font-bold text-3xl md:text-4xl origin-left transition-all duration-500 inline-block"
                        style="transition-timing-function: cubic-bezier(0.4, 0, 0.2, 1);"
                        :class="inChat ? 'scale-[0.6]' : 'scale-100'"
                        :style="inChat ? 'transform-origin: left center;' : 'transform-origin: center center;'">
                        Get a second opinion
                    </h1>
                </div>
                <button x-show="inChat"
                        x-transition:enter="transition ease-out duration-500 delay-200"
                        x-transition:enter-start="opacity-0 translate-x-4"
                        x-transition:enter-end="opacity-100 translate-x-0"
                        @click="reset"
                        class="text-gray-400 hover:text-white text-sm whitespace-nowrap ml-4">
                    New Chat
                </button>
            </div>

            <!-- Anxiety Spiral - fades out on chat -->
            <div class="spiral-container relative overflow-visible transition-all duration-500 ease-out pt-2"
                 :class="inChat ? 'opacity-0 max-h-0 mb-0 pt-0' : 'opacity-100 max-h-[400px] mb-6'">
                <div class="spiral-row">
                    <div class="thought-bubble text-sm bubble-1"
                         x-text="currentSpiral[0]"></div>
                </div>
                <div class="spiral-connector animate-grow-down connector-1"></div>
                <div class="spiral-row">
                    <div class="thought-bubble text-sm bubble-2"
                         x-text="currentSpiral[1]"></div>
                </div>
                <div class="spiral-connector animate-grow-down connector-2"></div>
                <div class="spiral-row">
                    <div class="thought-bubble text-sm bubble-3"
                         x-text="currentSpiral[2]"></div>
                </div>
                <div class="spiral-connector animate-grow-down connector-3"></div>
                <div class="spiral-row">
                    <div class="thought-bubble text-sm bubble-4"
                         x-text="currentSpiral[3]"></div>
                </div>
            </div>

            <!-- CTA Text - fades out -->
            <div class="transition-all duration-400 overflow-hidden"
                 :class="inChat ? 'opacity-0 max-h-0' : 'opacity-100 max-h-20 mb-4'">
                <p class="font-semibold mb-1">Stop the spiral.</p>
                <p class="text-gray-400 text-sm">Get clarity in minutes.</p>
            </div>

            <!-- Messages Area - grows in -->
            <div class="transition-all duration-400 ease-out overflow-hidden"
                 :class="inChat ? 'opacity-100 max-h-[40vh] mb-6' : 'opacity-0 max-h-0 mb-0'">
                <div class="space-y-4 overflow-y-auto max-h-[40vh]">
                    <template x-for="(msg, i) in messages" :key="i">
                        <div :class="msg.role === 'user' ? 'flex justify-end' : ''"
                             x-show="inChat"
                             x-transition:enter="transition duration-300 ease-out"
                             x-transition:enter-start="opacity-0 translate-y-2"
                             x-transition:enter-end="opacity-100 translate-y-0">
                            <div :class="msg.role === 'user' ? 'glass-card max-w-[80%]' : 'bg-transparent'" class="rounded-2xl p-4">
                                <!-- Typing state: plain text with cursor -->
                                <div x-show="msg.role === 'assistant' && isTyping(i)"
                                     class="text-sm text-gray-300 typing-cursor" x-text="typingText"></div>
                                <!-- Done typing: render markdown -->
                                <div x-show="msg.role !== 'assistant' || !isTyping(i)"
                                     class="text-sm text-gray-300 markdown-content" x-html="renderMarkdown(msg.content)"></div>
                            </div>
                        </div>
                    </template>
                    <div x-show="loading" class="text-gray-400 text-sm animate-pulse">Thinking...</div>
                    <div x-show="error"
                         x-transition:enter="transition ease-out duration-200"
                         x-transition:enter-start="opacity-0 translate-y-1"
                         x-transition:enter-end="opacity-100 translate-y-0"
                         x-transition:leave="transition ease-in duration-150"
                         x-transition:leave-start="opacity-100"
                         x-transition:leave-end="opacity-0"
                         class="text-red-400/80 text-sm" x-text="error"></div>
                </div>
            </div>

            <!-- Priorities UI - only in chat -->
            <div x-show="inChat && priorities.length > 0 && !prioritiesSubmitted && !activeWidget"
                 x-transition:enter="transition ease-out duration-300"
                 x-transition:enter-start="opacity-0 translate-y-4"
                 x-transition:enter-end="opacity-100 translate-y-0"
                 class="glass-card rounded-2xl p-5 mb-6">
                <h3 class="font-medium mb-3">Rank your priorities <span class="text-gray-400 text-sm">(drag to reorder)</span></h3>
                <ul class="space-y-2 mb-4">
                    <template x-for="(p, i) in priorities" :key="i">
                        <li draggable="true"
                            @dragstart="dragStart(i)"
                            @dragover.prevent="dragOver($event, i)"
                            @dragleave="dragLeave($event)"
                            @drop="drop($event, i)"
                            class="glass-chip rounded-xl p-3 cursor-move flex items-center text-sm group">
                            <span class="mr-3 text-gray-500">‚â°</span>
                            <input type="text" x-model="priorities[i]"
                                   class="flex-1 bg-transparent outline-none text-gray-200" @click.stop>
                            <button @click.stop="priorities.splice(i, 1)"
                                    class="ml-2 text-gray-500 hover:text-red-400 opacity-0 group-hover:opacity-100 transition-opacity">‚úï</button>
                        </li>
                    </template>
                </ul>
                <div class="flex gap-2 mb-4">
                    <input type="text" x-model="newPriority" @keydown.enter="addPriority"
                           placeholder="Add a priority..."
                           class="glass-input flex-1 rounded-xl px-4 py-2 text-sm text-white focus:outline-none">
                    <button @click="addPriority" :disabled="!newPriority.trim()"
                            class="bg-blue-500 hover:bg-blue-600 disabled:opacity-30 text-white px-4 py-2 rounded-xl text-sm transition-all">Add</button>
                </div>
                <button @click="submitPriorities"
                        class="bg-green-500 hover:bg-green-600 text-white px-5 py-2 rounded-xl text-sm transition-all">Confirm Ranking</button>
            </div>

            <!-- Input Area - always present, morphs -->
            <div class="relative transition-all duration-500">

                <!-- Landing textarea -->
                <div x-show="!inChat" class="relative">
                    <textarea
                        x-ref="landingTextarea"
                        x-model="input"
                        @keydown.enter.meta="submitInitial"
                        @keydown.enter.ctrl="submitInitial"
                        class="glass-input w-full rounded-2xl p-4 pr-16 text-white resize-none focus:outline-none min-h-[100px] transition-all duration-300"
                        placeholder="what's your situation?"
                        rows="3"
                    ></textarea>
                    <button
                        @click="submitInitial"
                        :disabled="!input.trim() || loading"
                        class="absolute bottom-4 right-4 bg-blue-500 hover:bg-blue-600 disabled:opacity-30 disabled:cursor-not-allowed text-white p-3 rounded-xl transition-colors"
                    >
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14 5l7 7m0 0l-7 7m7-7H3"/>
                        </svg>
                    </button>
                </div>

                <!-- Chat input -->
                <div x-show="inChat"
                     x-transition:enter="transition ease-out duration-300 delay-200"
                     x-transition:enter-start="opacity-0"
                     x-transition:enter-end="opacity-100"
                     class="relative">
                    <input
                        x-ref="chatInput"
                        x-model="input"
                        @keydown.enter="sendMessage"
                        class="glass-input w-full rounded-xl p-4 pr-14 text-white focus:outline-none focus:border-blue-400/50"
                        placeholder="Type your message..."
                    >
                    <button
                        @click="sendMessage"
                        :disabled="!input.trim() || loading"
                        class="absolute right-2 top-1/2 -translate-y-1/2 bg-blue-500 hover:bg-blue-600 disabled:opacity-30 text-white p-2 rounded-lg transition-all"
                    >
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14 5l7 7m0 0l-7 7m7-7H3"/>
                        </svg>
                    </button>
                </div>

                <!-- Example chips - only on landing -->
                <div class="flex flex-wrap gap-2 mt-4 text-sm text-gray-400 transition-all duration-300 overflow-hidden"
                     :class="inChat ? 'opacity-0 max-h-0' : 'opacity-100 max-h-20'">
                    <span>try:</span>
                    <button @click="useExample('Should I take this job offer?')" class="hover:text-white transition-colors">üíº job offer</button>
                    <span class="text-gray-600">¬∑</span>
                    <button @click="useExample('Should I move to a new city?')" class="hover:text-white transition-colors">üè† moving</button>
                    <span class="text-gray-600">¬∑</span>
                    <button @click="useExample('Should I end this relationship?')" class="hover:text-white transition-colors">‚ù§Ô∏è relationship</button>
                    <span class="text-gray-600">¬∑</span>
                    <button @click="useExample('Should I ask for a raise?')" class="hover:text-white transition-colors">üí∞ raise</button>
                </div>
            </div>

            <!-- WIDGET: Story Prompts -->
            <div x-show="activeWidget?.type === 'show_story_prompts'" class="glass-card rounded-2xl p-5 mb-6">
                <h3 class="font-medium mb-4">Let's discover what matters</h3>
                <p class="text-gray-400 text-sm mb-4">Sometimes we know what we want but can't name it. Let's try a different approach.</p>

                <template x-if="extractedPriorities.length === 0">
                    <div>
                        <label class="block text-sm text-gray-300 mb-2">Best case: 1 year from now, you LOVE this decision. What's happening?</label>
                        <textarea x-model="storyBestCase" class="glass-input w-full rounded-xl p-3 text-white text-sm mb-4 min-h-[80px]" placeholder="I'm happy because..."></textarea>

                        <label class="block text-sm text-gray-300 mb-2">Worst case: 1 year from now, you REGRET it. What went wrong?</label>
                        <textarea x-model="storyWorstCase" class="glass-input w-full rounded-xl p-3 text-white text-sm mb-4 min-h-[80px]" placeholder="I regret it because..."></textarea>

                        <button @click="submitStories" :disabled="!storyBestCase.trim() || !storyWorstCase.trim() || loading" class="bg-blue-500 hover:bg-blue-600 disabled:opacity-30 text-white px-5 py-2 rounded-xl text-sm">
                            Extract what matters
                        </button>
                    </div>
                </template>

                <template x-if="extractedPriorities.length > 0">
                    <div>
                        <p class="text-sm text-gray-300 mb-3">Based on your scenarios, here's what seems to matter:</p>
                        <ul class="space-y-2 mb-4">
                            <template x-for="p in extractedPriorities">
                                <li class="glass-chip rounded-xl p-3 text-sm flex items-center">
                                    <span class="text-green-400 mr-2">‚úì</span>
                                    <span x-text="p"></span>
                                </li>
                            </template>
                        </ul>
                        <button @click="confirmExtractedPriorities" class="bg-green-500 hover:bg-green-600 text-white px-5 py-2 rounded-xl text-sm">
                            These look right
                        </button>
                    </div>
                </template>
            </div>

            <!-- WIDGET: Card Sort -->
            <div x-show="activeWidget?.type === 'show_card_sort'" class="glass-card rounded-2xl p-5 mb-6">
                <h3 class="font-medium mb-2">What matters in this decision?</h3>
                <p class="text-gray-400 text-sm mb-4">Select all that apply:</p>

                <div class="grid grid-cols-2 md:grid-cols-3 gap-2 mb-4">
                    <template x-for="card in activeWidget?.params?.cards || []">
                        <button
                            @click="toggleCard(card)"
                            :class="selectedCards.some(c => c.label === card.label) ? 'bg-blue-500/30 border-blue-400' : 'glass-chip'"
                            class="rounded-xl p-3 text-left border border-transparent hover:border-blue-400/50 transition-all"
                        >
                            <div class="flex items-center gap-2">
                                <span x-text="card.emoji"></span>
                                <span class="text-sm font-medium" x-text="card.label"></span>
                            </div>
                            <p class="text-xs text-gray-400 mt-1" x-text="card.desc"></p>
                        </button>
                    </template>
                </div>

                <div class="flex items-center justify-between">
                    <span class="text-sm text-gray-400">Selected: <span x-text="selectedCards.length"></span></span>
                    <button @click="submitCards" :disabled="selectedCards.length === 0" class="bg-green-500 hover:bg-green-600 disabled:opacity-30 text-white px-5 py-2 rounded-xl text-sm">
                        Continue
                    </button>
                </div>
            </div>

            <!-- WIDGET: Priority Tournament -->
            <div x-show="activeWidget?.type === 'show_priority_tournament'" class="glass-card rounded-2xl p-5 mb-6">
                <h3 class="font-medium mb-2">Which matters more?</h3>
                <p class="text-gray-400 text-sm mb-4">
                    Matchup <span x-text="currentMatchupIndex + 1"></span> of <span x-text="tournamentMatchups.length"></span>
                </p>

                <template x-if="tournamentMatchups[currentMatchupIndex]">
                    <div class="flex gap-4">
                        <button
                            @click="pickWinner(tournamentMatchups[currentMatchupIndex].a)"
                            class="flex-1 glass-chip hover:bg-blue-500/20 hover:border-blue-400 rounded-xl p-6 text-center transition-all"
                        >
                            <span class="text-lg" x-text="tournamentMatchups[currentMatchupIndex].a"></span>
                        </button>
                        <span class="self-center text-gray-500">vs</span>
                        <button
                            @click="pickWinner(tournamentMatchups[currentMatchupIndex].b)"
                            class="flex-1 glass-chip hover:bg-blue-500/20 hover:border-blue-400 rounded-xl p-6 text-center transition-all"
                        >
                            <span class="text-lg" x-text="tournamentMatchups[currentMatchupIndex].b"></span>
                        </button>
                    </div>
                </template>

                <p class="text-xs text-gray-500 mt-4 text-center">Go with your gut. There's no wrong answer.</p>
            </div>

            <!-- WIDGET: Budget Allocation -->
            <div x-show="activeWidget?.type === 'show_budget_allocation'" class="glass-card rounded-2xl p-5 mb-6">
                <h3 class="font-medium mb-2">Distribute 100 points</h3>
                <p class="text-gray-400 text-sm mb-4">
                    Remaining: <span x-text="100 - totalAllocated" :class="totalAllocated === 100 ? 'text-green-400' : 'text-yellow-400'"></span>
                </p>

                <div class="space-y-4 mb-4">
                    <template x-for="(value, key) in budgetAllocations" :key="key">
                        <div class="flex items-center gap-4">
                            <span class="w-32 text-sm truncate" x-text="key"></span>
                            <input type="range" min="0" max="100" x-model.number="budgetAllocations[key]" class="flex-1 accent-blue-500">
                            <span class="w-12 text-right text-sm" x-text="budgetAllocations[key] + '%'"></span>
                        </div>
                    </template>
                </div>

                <button @click="submitBudget" :disabled="totalAllocated !== 100" class="bg-green-500 hover:bg-green-600 disabled:opacity-30 text-white px-5 py-2 rounded-xl text-sm">
                    Lock it in
                </button>
            </div>

            <!-- WIDGET: Elimination Game -->
            <div x-show="activeWidget?.type === 'show_elimination_game'" class="glass-card rounded-2xl p-5 mb-6">
                <h3 class="font-medium mb-2">Remove the one you could most live without</h3>
                <p class="text-gray-400 text-sm mb-4">Keep going until you have 3-4 remaining.</p>

                <div class="grid grid-cols-2 md:grid-cols-3 gap-2 mb-4">
                    <template x-for="p in eliminationRemaining">
                        <button @click="eliminatePriority(p)" class="glass-chip hover:bg-red-500/20 hover:border-red-400 rounded-xl p-4 text-sm group relative transition-all">
                            <span x-text="p"></span>
                            <span class="absolute top-1 right-2 text-red-400 opacity-0 group-hover:opacity-100">√ó</span>
                        </button>
                    </template>
                </div>

                <div x-show="eliminationRemoved.length > 0" class="text-xs text-gray-500">
                    Eliminated: <span x-text="eliminationRemoved.join(', ')"></span>
                </div>
            </div>

            <!-- WIDGET: Recommendation -->
            <div x-show="activeWidget?.type === 'show_recommendation'" class="glass-card rounded-2xl p-5 mb-6">
                <h3 class="font-medium mb-4">Based on your priorities</h3>

                <div class="space-y-3 mb-4">
                    <template x-for="option in activeWidget?.params?.options || []">
                        <div class="glass-chip rounded-xl p-4">
                            <div class="flex justify-between items-center mb-2">
                                <span class="font-medium" x-text="option.name"></span>
                                <span class="text-blue-400 font-bold" x-text="option.score + '/100'"></span>
                            </div>
                        </div>
                    </template>
                </div>

                <div class="flex gap-3">
                    <button
                        @click="() => { const top = activeWidget?.params?.options?.[0]; if(top) { messages.push({role:'user', content: 'I\\'ll go with ' + top.name}); activeWidget = null; sendFollowUp(); }}"
                        class="bg-green-500 hover:bg-green-600 text-white px-5 py-2 rounded-xl text-sm"
                    >
                        I'll go with the top choice
                    </button>
                    <button
                        @click="() => { messages.push({role:'user', content: 'I need more time to think about this...'}); activeWidget = null; sendFollowUp(); }"
                        class="glass-chip px-4 py-2 rounded-xl text-sm"
                    >
                        Need more time...
                    </button>
                </div>
            </div>

            <!-- WIDGET: Tradeoff Acknowledgment -->
            <div x-show="activeWidget?.type === 'show_tradeoff_acknowledgment'" class="glass-card rounded-2xl p-5 mb-6">
                <h3 class="font-medium mb-4">The trade-off you're making</h3>

                <div class="grid grid-cols-2 gap-4 mb-6">
                    <div>
                        <h4 class="text-green-400 text-sm font-medium mb-2">You're getting</h4>
                        <ul class="space-y-1">
                            <template x-for="item in activeWidget?.params?.gaining || []">
                                <li class="flex items-center gap-2 text-sm">
                                    <span class="text-green-400">‚úì</span>
                                    <span x-text="item"></span>
                                </li>
                            </template>
                        </ul>
                    </div>
                    <div>
                        <h4 class="text-red-400 text-sm font-medium mb-2">You're giving up</h4>
                        <ul class="space-y-1">
                            <template x-for="item in activeWidget?.params?.sacrificing || []">
                                <li class="flex items-center gap-2 text-sm">
                                    <span class="text-red-400">√ó</span>
                                    <span x-text="item"></span>
                                </li>
                            </template>
                        </ul>
                    </div>
                </div>

                <button @click="acceptTradeoff" class="bg-blue-500 hover:bg-blue-600 text-white px-5 py-2 rounded-xl text-sm">
                    I accept this trade-off
                </button>
            </div>

            <!-- WIDGET: Premortem -->
            <div x-show="activeWidget?.type === 'show_premortem'" class="glass-card rounded-2xl p-5 mb-6">
                <h3 class="font-medium mb-4">The worst realistic outcome</h3>

                <div class="glass-input rounded-xl p-4 mb-4 text-gray-300 text-sm">
                    <p x-text="activeWidget?.params?.worst_case"></p>
                </div>

                <p class="text-sm text-gray-400 mb-4">Can you live with this risk?</p>

                <div class="flex gap-3">
                    <button @click="acceptRisk" class="bg-green-500 hover:bg-green-600 text-white px-5 py-2 rounded-xl text-sm">
                        Yes, I can live with this
                    </button>
                    <button
                        @click="() => { messages.push({role:'user', content: 'Actually, this changes things...'}); activeWidget = null; sendFollowUp(); }"
                        class="glass-chip px-4 py-2 rounded-xl text-sm"
                    >
                        No, this changes things
                    </button>
                </div>
            </div>

            <!-- Action Buttons - only in chat -->
            <div x-show="inChat"
                 x-transition:enter="transition ease-out duration-300 delay-300"
                 x-transition:enter-start="opacity-0 translate-y-2"
                 x-transition:enter-end="opacity-100 translate-y-0"
                 class="flex gap-3 flex-wrap mt-4">
                <button @click="getPriorities" :disabled="loading || messages.length === 0"
                    class="glass-chip rounded-xl px-4 py-2 text-sm disabled:opacity-30 disabled:cursor-not-allowed">
                    üìã Rank Priorities
                </button>
            </div>

        </div>
    </div>
</div>

<script>
document.addEventListener('alpine:init', () => {
    Alpine.data('app', () => ({
        // Core state
        inChat: false,
        messages: [],
        input: '',
        loading: false,
        priorities: [],
        prioritiesSubmitted: false,
        dragIndex: null,
        newPriority: '',
        error: null,

        // Widget state
        activeWidget: null,
        storyBestCase: '',
        storyWorstCase: '',
        selectedCards: [],
        extractedPriorities: [],
        tournamentMatchups: [],
        currentMatchupIndex: 0,
        tournamentResults: [],
        budgetAllocations: {},
        eliminationRemaining: [],
        eliminationRemoved: [],

        // Typewriter state
        typingIndex: -1,
        typingText: '',
        typingGeneration: 0,

        // Anxiety spiral scenarios (randomized on load)
        currentSpiral: [],
        spiralScenarios: [
            [
                "Should I take this job? üòü",
                "But what if I hate it? üò∞",
                "What if I'm making a huge mistake? üò®",
                "What if I regret this forever? üò±"
            ],
            [
                "Should I end this relationship? üòü",
                "But what if I'm wrong? üò∞",
                "What if I never find someone else? üò®",
                "What if I end up alone forever? üò±"
            ],
            [
                "Should I move to a new city? üòü",
                "But what if I hate it there? üò∞",
                "What if I lose all my friends? üò®",
                "What if I can never come back? üò±"
            ],
            [
                "Should I ask for a raise? üòü",
                "But what if they say no? üò∞",
                "What if they think I'm greedy? üò®",
                "What if they fire me? üò±"
            ],
            [
                "Should I quit my job? üòü",
                "But what if I can't find another one? üò∞",
                "What if I run out of money? üò®",
                "What if I've ruined my career? üò±"
            ],
            [
                "Should I go back to school? üòü",
                "But what if it's too late? üò∞",
                "What if I can't handle it? üò®",
                "What if it's all for nothing? üò±"
            ],
            [
                "Should I start this business? üòü",
                "But what if it fails? üò∞",
                "What if I lose everything? üò®",
                "What if everyone thinks I'm a fool? üò±"
            ],
            [
                "Should I tell them how I feel? üòü",
                "But what if they don't feel the same? üò∞",
                "What if it ruins everything? üò®",
                "What if I lose them forever? üò±"
            ]
        ],

        init() {
            // Pick a random anxiety spiral on load
            const randomIndex = Math.floor(Math.random() * this.spiralScenarios.length);
            this.currentSpiral = this.spiralScenarios[randomIndex];

            // Configure marked.js for safe rendering
            marked.setOptions({
                breaks: true,
                gfm: true
            });
        },

        renderMarkdown(content) {
            if (!content) return '';
            return DOMPurify.sanitize(marked.parse(content), {
                ALLOWED_URI_REGEXP: /^(?:(?:https?|mailto):|[^a-z]|[a-z+.-]+(?:[^a-z+.\-:]|$))/i
            });
        },

        async typeMessage(messageIndex) {
            const fullText = this.messages[messageIndex].content;
            const words = fullText.split(/(\s+)/); // Split but keep whitespace
            const currentGeneration = this.typingGeneration;
            this.typingIndex = messageIndex;
            this.typingText = '';

            for (let i = 0; i < words.length; i++) {
                // Abort if a new message started typing or reset was called
                if (this.typingIndex !== messageIndex || this.typingGeneration !== currentGeneration) {
                    return;
                }
                this.typingText += words[i];
                // Faster for whitespace, slight pause for words
                const delay = words[i].trim() ? 35 : 10;
                await new Promise(r => setTimeout(r, delay));
            }

            // Done typing (only clear if still our message and same generation)
            if (this.typingIndex === messageIndex && this.typingGeneration === currentGeneration) {
                this.typingIndex = -1;
                this.typingText = '';
            }
        },

        isTyping(index) {
            return this.typingIndex === index;
        },

        useExample(text) {
            this.input = text;
        },

        async submitInitial() {
            if (!this.input.trim() || this.loading) return;

            this.error = null;
            this.messages.push({ role: 'user', content: this.input });
            this.input = '';
            this.inChat = true;

            // Make API call
            this.loading = true;
            try {
                const res = await fetch('/api/chat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ messages: this.messages })
                });
                if (!res.ok) {
                    throw new Error(`Server error: ${res.status}`);
                }
                const data = await res.json();
                if (data.response) {
                    this.messages.push({ role: 'assistant', content: data.response });
                }
                // Handle widget if AI called a tool
                if (data.widget) {
                    this.handleWidget(data.widget);
                }
                this.loading = false;
                if (data.response) {
                    this.typeMessage(this.messages.length - 1);
                }
            } catch (e) {
                this.error = 'Unable to connect. Please try again.';
                this.loading = false;
            }
        },

        async sendMessage() {
            if (!this.input.trim() || this.loading) return;
            this.error = null;
            this.messages.push({ role: 'user', content: this.input });
            this.input = '';
            this.activeWidget = null; // Clear any active widget
            this.loading = true;
            try {
                const res = await fetch('/api/chat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ messages: this.messages })
                });
                if (!res.ok) {
                    throw new Error(`Server error: ${res.status}`);
                }
                const data = await res.json();
                if (data.response) {
                    this.messages.push({ role: 'assistant', content: data.response });
                }
                // Handle widget if AI called a tool
                if (data.widget) {
                    this.handleWidget(data.widget);
                }
                this.loading = false;
                if (data.response) {
                    this.typeMessage(this.messages.length - 1);
                }
            } catch (e) {
                this.error = 'Unable to connect. Please try again.';
                this.loading = false;
            }
        },

        handleWidget(widget) {
            this.activeWidget = widget;

            // Initialize widget-specific state
            switch (widget.type) {
                case 'show_story_prompts':
                    this.storyBestCase = '';
                    this.storyWorstCase = '';
                    break;
                case 'show_card_sort':
                    this.selectedCards = [];
                    break;
                case 'show_priority_tournament':
                    this.initTournament(widget.params.priorities);
                    break;
                case 'show_budget_allocation':
                    this.initBudget(widget.params.priorities);
                    break;
                case 'show_elimination_game':
                    this.eliminationRemaining = [...widget.params.priorities];
                    this.eliminationRemoved = [];
                    break;
            }
        },

        // Story prompts widget
        async submitStories() {
            if (!this.storyBestCase.trim() || !this.storyWorstCase.trim()) return;
            this.loading = true;
            try {
                const res = await fetch('/api/extract-priorities', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        best_case: this.storyBestCase,
                        worst_case: this.storyWorstCase
                    })
                });
                const data = await res.json();
                this.extractedPriorities = data.priorities || [];
            } catch (e) {
                alert('Error extracting priorities: ' + e.message);
            }
            this.loading = false;
        },

        confirmExtractedPriorities() {
            const prioritiesText = this.extractedPriorities.join(', ');
            this.messages.push({ role: 'user', content: `Based on my scenarios, here are my priorities: ${prioritiesText}` });
            this.activeWidget = null;
            this.extractedPriorities = [];
            this.sendFollowUp();
        },

        // Card sort widget
        toggleCard(card) {
            const idx = this.selectedCards.findIndex(c => c.label === card.label);
            if (idx >= 0) {
                this.selectedCards.splice(idx, 1);
            } else {
                this.selectedCards.push(card);
            }
        },

        submitCards() {
            if (this.selectedCards.length === 0) return;
            const prioritiesText = this.selectedCards.map(c => c.label).join(', ');
            this.messages.push({ role: 'user', content: `The priorities that matter to me are: ${prioritiesText}` });
            this.activeWidget = null;
            this.selectedCards = [];
            this.sendFollowUp();
        },

        // Tournament widget
        initTournament(priorities) {
            const matchups = [];
            for (let i = 0; i < priorities.length; i++) {
                for (let j = i + 1; j < priorities.length; j++) {
                    matchups.push({ a: priorities[i], b: priorities[j] });
                }
            }
            // Shuffle matchups
            for (let i = matchups.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [matchups[i], matchups[j]] = [matchups[j], matchups[i]];
            }
            this.tournamentMatchups = matchups;
            this.currentMatchupIndex = 0;
            this.tournamentResults = [];
        },

        pickWinner(winner) {
            this.tournamentResults.push({ winner });
            this.currentMatchupIndex++;

            if (this.currentMatchupIndex >= this.tournamentMatchups.length) {
                this.finishTournament();
            }
        },

        finishTournament() {
            // Count wins
            const priorities = [...new Set(this.tournamentMatchups.flatMap(m => [m.a, m.b]))];
            const wins = {};
            priorities.forEach(p => wins[p] = 0);
            this.tournamentResults.forEach(r => wins[r.winner]++);

            // Sort by wins
            const ranked = Object.entries(wins)
                .sort((a, b) => b[1] - a[1])
                .map(([p]) => p);

            const rankingText = ranked.map((p, i) => `${i + 1}. ${p}`).join(', ');
            this.messages.push({ role: 'user', content: `My priorities ranked: ${rankingText}` });
            this.activeWidget = null;
            this.sendFollowUp();
        },

        // Budget allocation widget
        initBudget(priorities) {
            const evenSplit = Math.floor(100 / priorities.length);
            this.budgetAllocations = {};
            priorities.forEach((p, i) => {
                this.budgetAllocations[p] = i === 0 ? 100 - (evenSplit * (priorities.length - 1)) : evenSplit;
            });
        },

        get totalAllocated() {
            return Object.values(this.budgetAllocations).reduce((a, b) => a + b, 0);
        },

        submitBudget() {
            if (this.totalAllocated !== 100) return;
            const sorted = Object.entries(this.budgetAllocations)
                .sort((a, b) => b[1] - a[1])
                .map(([p, w]) => `${p} (${w}%)`);
            this.messages.push({ role: 'user', content: `My priority weights: ${sorted.join(', ')}` });
            this.activeWidget = null;
            this.sendFollowUp();
        },

        // Elimination widget
        eliminatePriority(p) {
            this.eliminationRemoved.push(p);
            this.eliminationRemaining = this.eliminationRemaining.filter(x => x !== p);

            if (this.eliminationRemaining.length <= 4) {
                const remainingText = this.eliminationRemaining.join(', ');
                this.messages.push({ role: 'user', content: `After elimination, my top priorities are: ${remainingText}` });
                this.activeWidget = null;
                this.sendFollowUp();
            }
        },

        // Tradeoff widget
        acceptTradeoff() {
            const choice = this.activeWidget?.params?.choice || 'this option';
            this.messages.push({ role: 'user', content: `I accept the trade-offs for ${choice}. I understand what I'm gaining and sacrificing.` });
            this.activeWidget = null;
            this.sendFollowUp();
        },

        // Premortem widget
        acceptRisk() {
            const choice = this.activeWidget?.params?.choice || 'this option';
            this.messages.push({ role: 'user', content: `Yes, I can live with the worst case for ${choice}. I'm ready to commit.` });
            this.activeWidget = null;
            this.sendFollowUp();
        },

        // Helper to continue conversation after widget
        async sendFollowUp() {
            this.loading = true;
            try {
                const res = await fetch('/api/chat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ messages: this.messages })
                });
                const data = await res.json();
                if (data.response) {
                    this.messages.push({ role: 'assistant', content: data.response });
                }
                if (data.widget) {
                    this.handleWidget(data.widget);
                }
                this.loading = false;
                if (data.response) {
                    this.typeMessage(this.messages.length - 1);
                }
            } catch (e) {
                this.error = 'Unable to connect. Please try again.';
                this.loading = false;
            }
        },

        async getPriorities() {
            this.error = null;
            this.loading = true;
            try {
                const res = await fetch('/api/priorities', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ messages: this.messages })
                });
                if (!res.ok) {
                    throw new Error(`Server error: ${res.status}`);
                }
                const data = await res.json();
                this.priorities = data.priorities;
                this.prioritiesSubmitted = false;
            } catch (e) {
                this.error = 'Unable to load priorities. Please try again.';
            }
            this.loading = false;
        },

        async submitPriorities() {
            this.error = null;
            this.prioritiesSubmitted = true;
            this.messages.push({
                role: 'user',
                content: 'My priorities (ranked): ' + this.priorities.join(', ')
            });
            this.loading = true;
            try {
                const res = await fetch('/api/chat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ messages: this.messages })
                });
                if (!res.ok) {
                    throw new Error(`Server error: ${res.status}`);
                }
                const data = await res.json();
                this.messages.push({ role: 'assistant', content: data.response });
                this.loading = false;
                this.typeMessage(this.messages.length - 1);
            } catch (e) {
                this.error = 'Unable to connect. Please try again.';
                this.loading = false;
            }
        },

        addPriority() {
            if (this.newPriority.trim()) {
                this.priorities.push(this.newPriority.trim());
                this.newPriority = '';
            }
        },

        reset() {
            this.inChat = false;
            this.messages = [];
            this.input = '';
            this.priorities = [];
            this.prioritiesSubmitted = false;
            this.newPriority = '';
            this.error = null;
            this.typingIndex = -1;
            this.typingText = '';
            this.typingGeneration++; // Abort any in-flight typing animations

            // Pick a new random spiral for variety
            const randomIndex = Math.floor(Math.random() * this.spiralScenarios.length);
            this.currentSpiral = this.spiralScenarios[randomIndex];
        },

        dragStart(i) { this.dragIndex = i; },
        dragOver(e, i) { e.target.closest('li')?.classList.add('drag-over'); },
        dragLeave(e) { e.target.closest('li')?.classList.remove('drag-over'); },
        drop(e, i) {
            e.target.closest('li')?.classList.remove('drag-over');
            const item = this.priorities.splice(this.dragIndex, 1)[0];
            this.priorities.splice(i, 0, item);
            this.dragIndex = null;
        }
    }));
});
</script>
</body>
</html>
